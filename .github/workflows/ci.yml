name: AI CI

on:
  push:
    branches: [main, develop, infra/cicd]
  # pull_request:
  #   branches: [main, develop]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # pip ì˜ì¡´ì„± ìºì‹± - ì„¤ì¹˜ ì†ë„ í–¥ìƒìš©
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruff pytest
          pip install -r requirements.txt

      # ========================================
      # ì •ì  ë¶„ì„ (Static Analysis)
      # ========================================

      # Ruff Lint (ì½”ë“œ í’ˆì§ˆ) : ì•ˆì“°ëŠ” ë³€ìˆ˜, ì¤‘ë³µ import, í•˜ë“œì½”ë”© ë“±
      - name: Run Ruff Lint
        run: ruff check .

      # Ruff Format (ì½”ë“œ ìŠ¤íƒ€ì¼) : ë“¤ì—¬ì“°ê¸°, ì¤„ë°”ê¿ˆ, ë„¤ì´ë° ë“±
      - name: Run Ruff Format Check
        run: ruff format --check .

      # ========================================
      # í…ŒìŠ¤íŠ¸ (pytest)
      # ========================================
      - name: Run Tests
        # env:
        #   # í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
        #   OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        #   MODEL_PATH: ${{ secrets.MODEL_PATH }}
        run: pytest

      # ========================================
      # ì•„í‹°íŒ©íŠ¸ ì €ì¥ (main ë¸Œëœì¹˜ë§Œ) - FastAPIëŠ” ë¹Œë“œ ì‚°ì¶œë¬¼ ì—†ìŒ
      # ========================================
      # Note: FastAPIëŠ” Python ê¸°ë°˜ìœ¼ë¡œ ì»´íŒŒì¼ ë¹Œë“œê°€ ì—†ì–´ ì•„í‹°íŒ©íŠ¸ ì €ì¥ ì œì™¸

  # ========================================
  # ì‹¤íŒ¨ ì•Œë¦¼ (Discord)
  # ========================================
  notify-failure:
    runs-on: ubuntu-latest
    needs: ci
    if: failure()
    steps:
      - name: Discord notification on failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: failure
          content: "<@&${{ secrets.AI_ROLE_ID }}> AI CI ì‹¤íŒ¨!"
          title: "ğŸ”´ AI CI Failed"
          description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **ì—ëŸ¬ ë¡œê·¸ ë³´ê¸°:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          color: 0xFF0000