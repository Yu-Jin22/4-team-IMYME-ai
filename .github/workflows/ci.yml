name: AI CI

on:
  push:
    branches: [main, develop, infra/cicd]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # pip ìºì‹± (requirements.txtê°€ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ ìºì‹œ ê²½ë¡œ ì‚¬ìš©)
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-cache

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruff pytest fastapi uvicorn  # í•„ìš” íŒ¨í‚¤ì§€ ì§ì ‘ ì„¤ì¹˜

      # ========================================
      # ì •ì  ë¶„ì„ (Static Analysis)
      # ========================================
      - name: Run Ruff Lint
        run: ruff check .

      - name: Run Ruff Format Check
        run: ruff format --check .

      # ========================================
      # í…ŒìŠ¤íŠ¸ (pytest)
      # ========================================
      - name: Run Tests
        run: pytest

  notify-failure:
    runs-on: ubuntu-latest
    needs: ci
    if: failure()
    steps:
      - name: Discord notification on failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: failure
          content: "<@&${{ secrets.AI_ROLE_ID }}> AI CI ì‹¤íŒ¨!"
          title: "ğŸ”´ AI CI Failed"
          description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **ì—ëŸ¬ ë¡œê·¸ ë³´ê¸°:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xFF0000
