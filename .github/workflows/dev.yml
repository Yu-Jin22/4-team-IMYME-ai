name: AI CI/CD v3

on:
  pull_request:
    branches:
      - dev
    paths:
      - ".github/**"
      - "ai_server/**"
  push:
    branches:
      - dev
    paths:
      - ".github/**"
      - "ai_server/**"

permissions:
  contents: read

concurrency:
  group: ai-cicd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 1) CI
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('ai_server/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r ai_server/requirements.txt
          pip install ruff pytest

      - name: Run Ruff Lint
        run: ruff check ai_server/

      - name: Run Ruff Format Check
        run: ruff format --check ai_server/

      - name: Run Tests
        working-directory: ai_server
        run: pytest || echo "No tests found, skipping."

  ci-notify-success:
    needs: ci
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CI success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: success
          title: "ğŸŸ¢ AI CI Success"
          content: "<@&${{ secrets.AI_ROLE_ID }}> AI CI ì„±ê³µ!"
          color: 0x00FF00

  ci-notify-failure:
    needs: ci
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CI failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: failure
          title: "ğŸ”´ AI CI Failed"
          content: "<@&${{ secrets.AI_ROLE_ID }}> AI CI ì‹¤íŒ¨!"
          color: 0xFF0000

  # 2) CD
  cd:
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest

    steps:
      # 0ï¸âƒ£ Runner IP íšë“ ë° ë³´ì•ˆ ê·¸ë£¹ ì¶”ê°€
      - name: Get Runner IP
        id: ip
        run: echo "ipv4=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT

      - name: Add IP to Security Group
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.ip.outputs.ipv4 }}/32"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy AI Server
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.DEV_SERVER_HOST }} 'bash -s' <<'EOF'
          set -euo pipefail

          APP_ROOT=/home/ubuntu/mine/ai
          RELEASES_DIR=$APP_ROOT/releases
          SHARED_DIR=$APP_ROOT/shared
          CURRENT_LINK=$APP_ROOT/current

          # ë¦´ë¦¬ì¦ˆ ì‹ë³„ì(ì´ˆ ë‹¨ìœ„)
          RELEASE_ID=$(date +%Y%m%d%H%M%S)
          RELEASE_DIR=$RELEASES_DIR/$RELEASE_ID

          # ë¡œê·¸/í™˜ê²½ë³€ìˆ˜/í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ íŒŒì¼
          LOG_DIR=$SHARED_DIR/logs
          LOG_FILE=$LOG_DIR/ai.log
          ENV_FILE=$SHARED_DIR/.env
          PID_FILE=$SHARED_DIR/ai.pid

          # venvëŠ” sharedì— 1ê°œë§Œ ìœ ì§€(ë¦´ë¦¬ì¦ˆë³„ ìƒì„± X)
          VENV_DIR=$SHARED_DIR/.venv

          # ì›ê²© ë ˆí¬ URL
          REPO_URL="https://github.com/100-hours-a-week/4-team-IMYME-ai.git"
          BRANCH="dev"

          echo "ğŸš€ AI Deploy start (release/current)"

          mkdir -p "$RELEASES_DIR" "$SHARED_DIR" "$LOG_DIR"

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "$SHARED_DIR/.env" ]; then
            echo "âŒ shared .env not found: $SHARED_DIR/.env"
            exit 1
          fi

          # ìƒˆ ë¦´ë¦¬ì¦ˆ í´ë”ì— ì½”ë“œ ìŠ¤ëƒ…ìƒ· ì €ì¥
          echo "ğŸ“¦ Create new release: $RELEASE_DIR"
          mkdir -p "$RELEASE_DIR"

          echo "ğŸ“¥ Clone repo snapshot (depth=1, branch=$BRANCH)"
          git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$RELEASE_DIR"
          # --depth 1 : ìµœì‹  ì»¤ë°‹ë§Œ ë°›ì•„ì„œ ë¹ ë¦„
          # ë¦´ë¦¬ì¦ˆ í´ë”ì— â€œê·¸ ì‹œì  ì½”ë“œâ€ê°€ ê·¸ëŒ€ë¡œ ë‚¨ìŒ â†’ ë¡¤ë°± ê°€ëŠ¥í•´ì§

          # ê°€ìƒí™˜ê²½ ì¤€ë¹„ + ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ›  Prepare venv: $VENV_DIR"

          if [ ! -d "$VENV_DIR" ]; then
            echo "ğŸ“¦ Creating shared virtual environment"
            python3 -m venv "$VENV_DIR"
          fi

          # venv í™œì„±í™”
          source "$VENV_DIR/bin/activate"

          echo "ğŸ“¦ Install dependencies"
          pip install --upgrade pip

          # requirementsëŠ” â€œìƒˆ ë¦´ë¦¬ì¦ˆ(current ê¸°ì¤€)â€ì˜ íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì¹˜/ì—…ë°ì´íŠ¸
          pip install -r "$RELEASE_DIR/ai_server/requirements.txt"

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (pid íŒŒì¼ ê¸°ì¤€)
          echo "ğŸ›‘ Stop existing AI process (pid file)"
          if [ -f "$PID_FILE" ]; then
            OLD_PID=$(cat "$PID_FILE" || true)
            if [ -n "${OLD_PID:-}" ] && kill -0 "$OLD_PID" 2>/dev/null; then
              echo " - stopping pid=$OLD_PID"
              kill "$OLD_PID" || true

              # ì¢…ë£Œ í™•ì¸(ìµœëŒ€ 10ì´ˆ)
              for i in {1..10}; do
                if kill -0 "$OLD_PID" 2>/dev/null; then
                  echo "   waiting... ($i/10)"
                  sleep 1
                else
                  echo "   stopped"
                  break
                fi
              done

              # ê·¸ë˜ë„ ì‚´ì•„ìˆìœ¼ë©´ ê°•ì œ ì¢…ë£Œ
              if kill -0 "$OLD_PID" 2>/dev/null; then
                echo " - still alive, SIGKILL"
                kill -9 "$OLD_PID" || true
              fi
            else
              echo " - pid file exists but process not running (pid=$OLD_PID)"
            fi
          else
            echo " - pid file not found (maybe not running)"
          fi

          # í¬íŠ¸ ì ìœ  í”„ë¡œì„¸ìŠ¤ ë¬´ì¡°ê±´ ì¢…ë£Œ
          PIDS=$(lsof -t -i :8000 -nP 2>/dev/null || true)

          if [ -n "${PIDS:-}" ]; then
            echo " - found: $PIDS"
            kill $PIDS || true

            # ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°
            for i in {1..10}; do
              if lsof -t -i :8000 -nP >/dev/null 2>&1; then
                echo "   waiting port release... ($i/10)"
                sleep 1
              else
                echo "   port 8000 released"
                break
              fi
            done

            # ì•„ì§ë„ ì ìœ  ì¤‘ì´ë©´ ê°•ì œ ì¢…ë£Œ
            if lsof -t -i :8000 -nP >/dev/null 2>&1; then
              echo " - still in use, SIGKILL"
              kill -9 $(lsof -t -i :8000 -nP 2>/dev/null || true) || true
            fi
          fi

          # current ì‹¬ë³¼ë¦­ ë§í¬ êµì²´ 
          echo "ğŸ” Switch current -> $RELEASE_DIR"
          ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

          # ì„œë²„ ì‹œì‘
          echo "â–¶ Start AI server (current)"

          # envë¥¼ export ìƒíƒœë¡œ ë¡œë“œí•˜ì—¬ uvicornì— ì „ë‹¬
          set -a
          source "$ENV_FILE"
          set +a

          # current ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰
          cd "$CURRENT_LINK/ai_server"

          nohup uvicorn app.main:app \
            --host 0.0.0.0 \
            --port 8000 \
            >> "$LOG_FILE" 2>&1 </dev/null &

          NEW_PID=$!
          echo "$NEW_PID" > "$PID_FILE"
          echo "âœ… AI server started (pid=$NEW_PID)"

          # í—¬ìŠ¤ì²´í¬ (ë¡œì»¬)
          echo "ğŸ” Health check"
          for i in {1..10}; do
            if curl -sf http://127.0.0.1:8000/ > /dev/null; then
              echo "âœ… Health check passed"
              break
            fi
            echo "â³ Waiting for server..."
            sleep 2
          done

          if ! curl -sf http://127.0.0.1:8000/ > /dev/null; then
            echo "âŒ Health check failed"
            tail -n 200 "$LOG_FILE" || true
            exit 1
          fi

          # ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ (ìµœê·¼ 3ê°œë§Œ ë³´ê´€)
          echo "ğŸ§¹ Cleanup old releases (keep last 3)"
          ls -1dt "$RELEASES_DIR"/* | tail -n +4 | xargs -r rm -rf

          echo "ğŸ‰ AI Deploy finished"
          EOF

      # ë°°í¬ í›„ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
      - name: Post-deploy Smoke Test (AI)
        run: |
          set -euo pipefail

          BASE_URL="${{ secrets.DEV_BASE_URL }}"

          echo "ğŸ” Smoke 1) /ai/health should return 200"
          curl -fsS "${BASE_URL}/ai/health" >/dev/null

          echo "ğŸ” Smoke 2) POST ai/api/v1/knowledge/candidates/batch should succeed"
          # ì‘ë‹µì„ íŒŒì¼ë¡œ ì €ì¥í•˜ê³  HTTP ìƒíƒœì½”ë“œ ë¶„ë¦¬
          HTTP_CODE=$(curl --max-time 180 -sS -o /tmp/ai_batch_resp.json -w "%{http_code}" \
            -X POST "${BASE_URL}/ai/api/v1/knowledge/candidates/batch" \
            -H "Content-Type: application/json" \
            -H "x-internal-secret: ${{ secrets.INTERNAL_SECRET_KEY }}" \
            --data '{
              "items": [
                {
                  "id": "history_125",
                  "keyword": "ìš´ì˜ì²´ì œ",
                  "rawFeedback": "ìš´ì˜ì²´ì œ"
                }
              ]
            }')

          # ìƒíƒœì½”ë“œê°€ 200~299 ì‚¬ì´ì¸ì§€ í™•ì¸.
          [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] || {
            echo "âŒ HTTP $HTTP_CODE"
            cat /tmp/ai_batch_resp.json
            exit 1
          }

          # ì‘ë‹µ JSON ì•ˆì— "success": trueê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸.
          grep -q '"success"[[:space:]]*:[[:space:]]*true' /tmp/ai_batch_resp.json || {
            echo "âŒ success=true not found"
            cat /tmp/ai_batch_resp.json
            exit 1
          }

          echo "âœ… AI smoke tests passed"

      # 5ï¸âƒ£ ë³´ì•ˆ ê·¸ë£¹ì—ì„œ IP ì œê±° (í•­ìƒ ì‹¤í–‰)
      - name: Remove IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.ip.outputs.ipv4 }}/32"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

  cd-notify-success:
    needs: cd
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CD success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: success
          title: "ğŸŸ¢ AI Deploy Success"
          content: "AI ì„œë²„ ê°œë°œ ì„œë²„ ë°°í¬ ì™„ë£Œ!"
          color: 0x00FF00

  cd-notify-failure:
    needs: cd
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CD failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: failure
          title: "ğŸ”´ AI Deploy Failed"
          content: "<@&${{ secrets.AI_ROLE_ID }}> AI ê°œë°œ ì„œë²„ ë°°í¬ ì‹¤íŒ¨!"
          color: 0xFF0000
