name: AI CD (v 1.01)

on:
#   pull_request:
#     types: [closed]
#     branches:
#       - dev
  push:
    branches:
        - infra/cicd

jobs:
  deploy-dev:
    # if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ SSH ì„¸íŒ…
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      # 2ï¸âƒ£ SSH ì ‘ì† í›„ ë°°í¬
      - name: Deploy AI Server to Dev
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.DEV_SERVER_HOST }} 'bash -s' <<'EOF'
          set -e

          echo "ğŸš€ AI Deploy start"

          cd /home/ubuntu/mine/ai-server

          echo "ğŸ“¥ Git sync"
          git fetch origin dev
          git reset --hard origin/dev

          echo "ğŸ›  Install dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt || pip install fastapi uvicorn  # requirements ì—†ìœ¼ë©´ ê¸°ë³¸ ì„¤ì¹˜

          echo "ğŸ›‘ Stop existing AI process"
          pkill -f 'uvicorn.*app' || true
          sleep 3

          echo "â–¶ Start AI server"
          mkdir -p /home/ubuntu/logs
          export $(cat /home/ubuntu/mine/ai-server/.env | xargs)

          nohup uvicorn main:app \
            --host 0.0.0.0 \
            --port 8000 \
            --reload \
            > /home/ubuntu/logs/ai.log 2>&1 &

          sleep 5

          if pgrep -f 'uvicorn.*app' > /dev/null; then
            echo "âœ… AI server started successfully"
          else
            echo "âŒ AI server failed to start"
            cat /home/ubuntu/logs/ai.log
            exit 1
          fi

          echo "ğŸ‰ AI Deploy finished"
          EOF

  notify-success:
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: success()
    steps:
      - name: Discord notification on success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: success
          content: "AI ì„œë²„ ê°œë°œì„œë²„ ë°°í¬ ì™„ë£Œ!"
          title: "ğŸŸ¢ AI Deploy Success"
          description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
          color: 0x00FF00

  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: failure()
    steps:
      - name: Discord notification on failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_AI }}
          status: failure
          content: "<@&${{ secrets.AI_ROLE_ID }}> AI ì„œë²„ ë°°í¬ ì‹¤íŒ¨!"
          title: "ğŸ”´ AI Deploy Failed"
          description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **ì—ëŸ¬ ë¡œê·¸:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xFF0000
